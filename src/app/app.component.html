<div id="map"></div>

<app-sidebar [map]="map" 
             (toolSelected)="handleToolSelection($event)"
             (layerControlToggled)="toggleLayerControl()"
             (searchControlToggled)="toggleSearchControl()"
             (measureControlToggled)="toggleMeasureControl()"
             (geoJsonControlToggled)="toggleGeoJsonControl()"
             (polygonControlToggled)="togglePolygonControl()"
             (dataSendingControlToggled)="toggleDataSendingControl()"
             (settingsControlToggled)="toggleSettingsControl()"
             (favoritesControlToggled)="toggleFavoritesControl()"
             (findLocationRequested)="findMyLocation()"></app-sidebar>

<!-- Measurement Modal Component -->
<app-measurement-modal
  [isVisible]="showMeasureControl"
  [distance]="measureDistance"
  [canUndo]="measurePoints.length > 0"
  (close)="toggleMeasureControl()"
  (clear)="clearMeasurement()"
  (undo)="undoLastMeasurementPoint()">
</app-measurement-modal>

<!-- Control panels will be displayed here but not in a control-panel div -->

  
  <!-- Layer Control Panel -->
  <div *ngIf="showLayerControl" class="control-panel-content layer-panel">
    <div class="panel-header">
      <h3>Map Layers</h3>
      <button class="close-button" (click)="toggleLayerControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="layer-options">
      <div class="layer-option" 
           *ngFor="let layer of ['roadmap', 'satellite', 'hybrid', 'terrain', 'osm']"
           [class.active]="selectedLayer === layer"
           (click)="changeMapLayer(layer)">
        <i class="fa" 
           [ngClass]="{
             'fa-road': layer === 'roadmap',
             'fa-satellite': layer === 'satellite',
             'fa-layer-group': layer === 'hybrid',
             'fa-mountain': layer === 'terrain',
             'fa-map': layer === 'osm'
           }"></i>
        {{ layer | titlecase }}
      </div>
    </div>
  </div>
  
  <!-- Search Control Panel -->
  <div *ngIf="showSearchControl" class="control-panel-content search-panel">
    <div class="panel-header">
      <h3>Search</h3>
      <button class="close-button" (click)="toggleSearchControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="search-box">
      <input type="text" 
             [(ngModel)]="searchQuery" 
             (input)="onSearchInput()" 
             placeholder="Search location">
      
      <div *ngIf="isSearching" class="search-loading">
        <i class="fa fa-spinner fa-spin"></i> Searching...
      </div>
      
      <div *ngIf="searchResults.length > 0" class="search-results">
        <div *ngFor="let result of searchResults" 
             class="search-result-item"
             (click)="goToLocation(result)">
          {{ result.display_name }}
        </div>
      </div>
    </div>
    
    <div class="coordinates-search-box">
      <input type="text" 
             [(ngModel)]="coordinatesQuery" 
             placeholder="Lat, Lng (e.g. 51.505, -0.09)">
      <button (click)="searchByCoordinates()" class="primary-button">
        <i class="fa fa-search-location"></i> Go
      </button>
    </div>
  </div>
  
  <!-- GeoJSON Control Panel -->
  <div *ngIf="showGeoJsonControl" class="control-panel-content geojson-panel">
    <div class="panel-header">
      <h3>GeoJSON</h3>
      <button class="close-button" (click)="toggleGeoJsonControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <app-geojson-control [map]="map"></app-geojson-control>
  </div>
  
  <!-- Polygon Control Panel -->
  <div *ngIf="showPolygonControl" class="control-panel-content polygon-panel">
    <div class="panel-header">
      <h3>Draw Polygon</h3>
      <button class="close-button" (click)="togglePolygonControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div *ngIf="!showPolygonNameInput">
      <p class="instruction-text">Click on the map to add points</p>
      
      <div class="polygon-actions">
        <button (click)="finishPolygonDrawing()" 
                [disabled]="tempPolygonPoints.length < 3"
                class="primary-button">
          <i class="fa fa-check"></i> Finish
        </button>
        <button (click)="cancelPolygonDrawing()" class="secondary-button">
          <i class="fa fa-times"></i> Cancel
        </button>
      </div>
    </div>
    
    <div *ngIf="showPolygonNameInput" class="name-input-container">
      <input type="text" 
             [(ngModel)]="newPolygonName" 
             placeholder="Polygon name"
             autofocus>
      <button (click)="savePolygonAsFavorite()" 
              [disabled]="!newPolygonName.trim()"
              class="success-button">
        <i class="fa fa-save"></i> Save
      </button>
    </div>
  </div>
  
  <!-- Data Sending Control Panel -->
  <div *ngIf="showDataSendingControl" class="control-panel-content data-panel">
    <div class="panel-header">
      <h3>Data Sending</h3>
      <button class="close-button" (click)="toggleDataSendingControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <p class="instruction-text">Click on the map to send coordinates to API</p>
    <div class="api-status">
      <div class="status-item">
        <span class="status-label">API:</span>
        <span class="status-active">Active</span>
      </div>
      <div class="status-item">
        <span class="status-label">Endpoint:</span>
        <span class="status-value">{{ apiSettings.apiUrl | slice:0:20 }}...</span>
      </div>
    </div>
  </div>
  
  <!-- Settings Control Panel -->
  <div *ngIf="showSettingsControl" class="control-panel-content settings-panel">
    <div class="panel-header">
      <h3>API Settings</h3>
      <button class="close-button" (click)="toggleSettingsControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="settings-form">
      <div class="form-group">
        <label for="apiUrl">API URL</label>
        <input type="text" id="apiUrl" [(ngModel)]="apiSettings.apiUrl" placeholder="API URL">
      </div>
      <div class="form-group">
        <label for="bearerId">Bearer ID</label>
        <input type="text" id="bearerId" [(ngModel)]="apiSettings.bearerId" placeholder="Bearer ID">
      </div>
      <div class="form-group">
        <label for="trackerId">Tracker ID</label>
        <input type="text" id="trackerId" [(ngModel)]="apiSettings.trackerId" placeholder="Tracker ID">
      </div>
      <button (click)="saveSettings()" class="success-button">
        <i class="fa fa-save"></i> Save
      </button>
    </div>
  </div>
  
  <!-- Favorites Control Panel -->
  <div *ngIf="showFavoritesControl" class="control-panel-content favorites-panel">
    <div class="panel-header">
      <h3>Favorites</h3>
      <button class="close-button" (click)="toggleFavoritesControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div *ngIf="favoritePolygons.length === 0" class="no-favorites">
      <i class="fa fa-star"></i>
      <p>No favorites yet</p>
    </div>
    <div *ngIf="favoritePolygons.length > 0" class="favorites-list">
      <div *ngFor="let favorite of favoritePolygons" class="favorite-item" [class.active]="currentPolygonId === favorite.id">
        <div class="favorite-info">
          <h4>
            {{ favorite.name }}
            <span *ngIf="currentPolygonId === favorite.id" class="current-badge">
              <i class="fa fa-check"></i>
            </span>
          </h4>
          <small>{{ favorite.createdAt | date:'short' }}</small>
        </div>
        <div class="favorite-actions">
          <button class="icon-button" (click)="loadFavoritePolygon(favorite)" title="Load">
            <i class="fa fa-map-marker-alt"></i>
          </button>
          <button class="icon-button delete" (click)="deleteFavoritePolygon(favorite)" title="Delete">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>