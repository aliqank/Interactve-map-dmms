<div id="map"></div>

<app-sidebar [map]="map" 
             [apiError]="apiError"
             (toolSelected)="handleToolSelection($event)"
             (layerControlToggled)="toggleLayerControl()"
             (searchControlToggled)="toggleSearchControl()"
             (measureControlToggled)="toggleMeasureControl()"
             (geoJsonControlToggled)="toggleGeoJsonControl()"
             (polygonControlToggled)="togglePolygonControl()"
             (dataSendingControlToggled)="toggleDataSendingControl()"
             (settingsControlToggled)="toggleSettingsControl()"
             (favoritesControlToggled)="toggleFavoritesControl()"
             (findLocationRequested)="findMyLocation()"></app-sidebar>

<!-- Measurement Modal Component -->
<app-measurement-modal
  [isVisible]="showMeasureControl"
  [distance]="measureDistance"
  [canUndo]="measurePoints.length > 0"
  (close)="toggleMeasureControl()"
  (clear)="clearMeasurement()"
  (undo)="undoLastMeasurementPoint()">
</app-measurement-modal>

<!-- Control panels will be displayed here but not in a control-panel div -->

  
  <!-- Layer Control Panel -->
  <app-layer-control *ngIf="showLayerControl"></app-layer-control>
  
  <!-- Search Control Panel -->
  <div *ngIf="showSearchControl" class="modal-panel search-modal" #searchModal (mousedown)="startModalDrag($event, searchModal)" (touchstart)="startModalDrag($event, searchModal)">
    <div class="modal-header">
      <h3><i class="fa fa-search"></i> Search</h3>
      <button class="modal-close" (click)="toggleSearchControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="modal-content">
      <!-- Location search -->
      <div class="search-section">
        <div class="setting-label">
          <i class="fa fa-map-marker-alt"></i> Find location
        </div>
        <div class="search-input-wrapper">
          <input type="text" 
                 [(ngModel)]="searchQuery" 
                 (input)="onSearchInput()" 
                 class="setting-input"
                 placeholder="Enter location name">
          <div *ngIf="isSearching" class="search-indicator">
            <i class="fa fa-spinner fa-spin"></i>
          </div>
          <button *ngIf="searchQuery && !isSearching" 
                  (click)="clearSearch()" 
                  class="clear-button" 
                  title="Clear search">
            <i class="fa fa-times-circle"></i>
          </button>
        </div>
        
        <div *ngIf="searchResults.length > 0" class="search-results">
          <div *ngFor="let result of searchResults" 
               class="search-result-item"
               (click)="goToLocation(result)">
            <i class="fa fa-map-pin result-icon"></i>
            <span class="result-text">{{ result.display_name | slice:0:40 }}{{ result.display_name.length > 40 ? '...' : '' }}</span>
          </div>
        </div>
      </div>
      
      <!-- Coordinates search -->
      <div class="search-section">
        <div class="setting-label">
          <i class="fa fa-compass"></i> Go to coordinates
        </div>
        <div class="coordinates-search-wrapper">
          <div class="coordinates-input-wrapper">
            <input type="text" 
                   [(ngModel)]="coordinatesQuery" 
                   class="setting-input"
                   placeholder="Lat, Lng (e.g. 51.5, -0.09)">
            <button *ngIf="coordinatesQuery" 
                    (click)="clearCoordinates()" 
                    class="clear-button" 
                    title="Clear coordinates">
              <i class="fa fa-times-circle"></i>
            </button>
          </div>
          <button (click)="searchByCoordinates()" class="search-go-button">
            <i class="fa fa-location-arrow"></i> Go
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- GeoJSON Control Panel -->
  <div *ngIf="showGeoJsonControl" class="modal-panel geojson-modal" #geojsonModal (mousedown)="startModalDrag($event, geojsonModal)" (touchstart)="startModalDrag($event, geojsonModal)">
    <div class="modal-header">
      <h3><i class="fa fa-file-code"></i> GeoJSON</h3>
      <button class="modal-close" (click)="toggleGeoJsonControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="modal-content">
      <app-geojson-control [map]="map"></app-geojson-control>
    </div>
  </div>
  
  <!-- Polygon Control Panel -->
  <div *ngIf="showPolygonControl" class="modal-panel polygon-modal" #polygonModal (mousedown)="startModalDrag($event, polygonModal)" (touchstart)="startModalDrag($event, polygonModal)">
    <div class="modal-header">
      <h3><i class="fa fa-draw-polygon"></i> Draw Polygon</h3>
      <button class="modal-close" (click)="togglePolygonControl()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="modal-content">
      <div *ngIf="!showPolygonNameInput">
        <div class="polygon-instructions">
          <i class="fa fa-info-circle"></i>
          <span>Click on the map to add points. You need at least 3 points to create a polygon.</span>
        </div>
        
        <div class="polygon-points-counter">
          <span class="counter-label">Points:</span>
          <span class="counter-value">{{ tempPolygonPoints.length }}</span>
          <span class="counter-min">(min 3)</span>
        </div>
        
        <div class="polygon-actions">
          <button (click)="finishPolygonDrawing()" 
                  [disabled]="tempPolygonPoints.length < 3"
                  class="polygon-action-button finish-button">
            <i class="fa fa-check"></i> Finish
          </button>
          <button (click)="cancelPolygonDrawing()" class="polygon-action-button cancel-button">
            <i class="fa fa-times"></i> Cancel
          </button>
        </div>
      </div>
      
      <div *ngIf="showPolygonNameInput" class="polygon-name-form">
        <div class="setting-label">
          <i class="fa fa-tag"></i> Polygon Name
        </div>
        <div class="polygon-name-input-wrapper">
          <input type="text" 
                 [(ngModel)]="newPolygonName" 
                 placeholder="Enter polygon name"
                 class="setting-input"
                 autofocus>
        </div>
        <button (click)="savePolygonAsFavorite()" 
                [disabled]="!newPolygonName.trim()"
                class="save-polygon-button">
          <i class="fa fa-save"></i> Save Polygon
        </button>
      </div>
    </div>
  </div>
  
  <!-- Settings Control Panel -->
  <app-settings
    [isVisible]="showSettingsControl"
    [apiSettings]="apiSettings"
    (visibilityChange)="toggleSettingsControl()"
    (settingsSaved)="apiSettings = $event">
  </app-settings>
  
  <!-- Favorites Control Panel -->
  <app-favorites
    [isVisible]="showFavoritesControl"
    [favoritePolygons]="favoritePolygons"
    [currentPolygonId]="currentPolygonId"
    (visibilityChange)="toggleFavoritesControl()"
    (loadFavorite)="loadFavoritePolygon($event)"
    (deleteFavorite)="deleteFavoritePolygon($event)">
  </app-favorites>
  
  <!-- Data Sending Control Panel -->
  <app-data-sending
    [isVisible]="showDataSendingControl"
    [map]="map"
    [apiSettings]="apiSettings"
    [apiError]="apiError"
    (visibilityChange)="toggleDataSendingControl()"
    (apiErrorChange)="apiError = $event">
  </app-data-sending>