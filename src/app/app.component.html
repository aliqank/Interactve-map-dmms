<div id="map"></div>

<app-sidebar [map]="map" 
             (toolSelected)="handleToolSelection($event)"
             (layerControlToggled)="toggleLayerControl()"
             (searchControlToggled)="toggleSearchControl()"
             (measureControlToggled)="toggleMeasureControl()"
             (geoJsonControlToggled)="toggleGeoJsonControl()"
             (polygonControlToggled)="togglePolygonControl()"
             (dataSendingControlToggled)="toggleDataSendingControl()"
             (settingsControlToggled)="toggleSettingsControl()"
             (favoritesControlToggled)="toggleFavoritesControl()"
             (findLocationRequested)="findMyLocation()"></app-sidebar>

<!-- Measurement Modal Component -->
<app-measurement-modal
  [isVisible]="showMeasureControl"
  [distance]="measureDistance"
  [canUndo]="measurePoints.length > 0"
  (close)="toggleMeasureControl()"
  (clear)="clearMeasurement()"
  (undo)="undoLastMeasurementPoint()">
</app-measurement-modal>

<!-- Control panels will be displayed here but not in a control-panel div -->

  
  <!-- Layer Control Panel -->
  <div *ngIf="showLayerControl" class="control-panel-content">
    <h3>Map Layers</h3>
    <div class="layer-options">
      <div class="layer-option" [class.active]="selectedLayer === 'roadmap'" (click)="changeMapLayer('roadmap')">
        <i class="fa fa-road"></i>
        <span>Road Map</span>
      </div>
      <div class="layer-option" [class.active]="selectedLayer === 'satellite'" (click)="changeMapLayer('satellite')">
        <i class="fa fa-satellite"></i>
        <span>Satellite</span>
      </div>
      <div class="layer-option" [class.active]="selectedLayer === 'hybrid'" (click)="changeMapLayer('hybrid')">
        <i class="fa fa-globe"></i>
        <span>Hybrid</span>
      </div>
      <div class="layer-option" [class.active]="selectedLayer === 'terrain'" (click)="changeMapLayer('terrain')">
        <i class="fa fa-mountain"></i>
        <span>Terrain</span>
      </div>
      <div class="layer-option" [class.active]="selectedLayer === 'osm'" (click)="changeMapLayer('osm')">
        <i class="fa fa-map-marked-alt"></i>
        <span>OpenStreetMap</span>
      </div>
    </div>
  </div>
  
  <!-- Search Control Panel -->
  <div *ngIf="showSearchControl" class="control-panel-content">
    <h3>Search Location</h3>
    <div class="search-box">
      <div class="input-with-icon">
        <i class="fa fa-search"></i>
        <input type="text" [(ngModel)]="searchQuery" (input)="onSearchInput()" placeholder="Enter location...">
      </div>
      <div *ngIf="isSearching" class="search-loading">
        <i class="fa fa-spinner fa-spin"></i> Searching...
      </div>
    </div>
    <div *ngIf="searchResults.length > 0" class="search-results">
      <div *ngFor="let result of searchResults" class="search-result-item" (click)="goToLocation(result)">
        <i class="fa fa-map-marker-alt"></i> {{ result.display_name }}
      </div>
    </div>
    
    <h3>Search by Coordinates</h3>
    <div class="coordinates-search-box">
      <div class="input-with-icon">
        <i class="fa fa-crosshairs"></i>
        <input type="text" [(ngModel)]="coordinatesQuery" placeholder="Lat, Lng (e.g. 51.5074, -0.1278)">
      </div>
      <button (click)="searchByCoordinates()" class="search-button">
        <i class="fa fa-search-location"></i> Search
      </button>
    </div>
  </div>
  
  <!-- GeoJSON Control Panel -->
  <div *ngIf="showGeoJsonControl" class="control-panel-content">
    <h3>GeoJSON Control</h3>
    <app-geojson-control [map]="map"></app-geojson-control>
  </div>
  
  <!-- Polygon Control Panel -->
  <div *ngIf="showPolygonControl" class="control-panel-content">
    <h3>Polygon Drawing</h3>
    <p class="instruction-text">
      <i class="fa fa-info-circle"></i> Click on the map to add polygon points
    </p>
    <div class="polygon-actions">
      <button (click)="finishPolygonDrawing()" class="primary-button">
        <i class="fa fa-check"></i> Finish
      </button>
      <button (click)="cancelPolygonDrawing()" class="secondary-button">
        <i class="fa fa-times"></i> Cancel
      </button>
    </div>
  </div>
  
  <!-- Settings Control Panel -->
  <div *ngIf="showSettingsControl" class="control-panel-content">
    <h3>API Settings</h3>
    <div class="settings-form">
      <div class="form-group">
        <label for="apiUrl">API Endpoint</label>
        <input type="text" id="apiUrl" [(ngModel)]="apiSettings.apiUrl" placeholder="Enter API URL">
      </div>
      <div class="form-group">
        <label for="bearerId">Bearer ID</label>
        <input type="text" id="bearerId" [(ngModel)]="apiSettings.bearerId" placeholder="Enter Bearer ID">
      </div>
      <div class="form-group">
        <label for="trackerId">Tracker ID</label>
        <input type="text" id="trackerId" [(ngModel)]="apiSettings.trackerId" placeholder="Enter Tracker ID">
      </div>
      <button (click)="saveSettings()" class="success-button">
        <i class="fa fa-save"></i> Save Settings
      </button>
    </div>
  </div>
  
  <!-- Favorites Control Panel -->
  <div *ngIf="showFavoritesControl" class="control-panel-content">
    <h3>Favorite Polygons</h3>
    <div *ngIf="favoritePolygons.length === 0" class="no-favorites">
      <i class="fa fa-star"></i>
      <p>No favorite polygons saved yet.</p>
      <p>Draw a polygon and save it to see it here.</p>
    </div>
    <div *ngIf="favoritePolygons.length > 0" class="favorites-list">
      <div *ngFor="let favorite of favoritePolygons" class="favorite-item" [class.active]="currentPolygonId === favorite.id">
        <div class="favorite-info">
          <h4>
            {{ favorite.name }}
            <span *ngIf="currentPolygonId === favorite.id" class="current-badge">
              <i class="fa fa-check"></i> Current
            </span>
          </h4>
          <small>{{ favorite.createdAt | date:'short' }}</small>
        </div>
        <div class="favorite-actions">
          <button class="icon-button" (click)="loadFavoritePolygon(favorite)" title="Load this polygon">
            <i class="fa fa-map-marker-alt"></i>
          </button>
          <button class="icon-button delete" (click)="deleteFavoritePolygon(favorite)" title="Delete this polygon">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Polygon Name Input -->
  <div *ngIf="showPolygonNameInput" class="control-panel-content">
    <h3>Save Polygon</h3>
    <div class="input-group">
      <input type="text" class="form-input" [(ngModel)]="newPolygonName" placeholder="Enter a name for this polygon">
      <div class="button-group">
        <button (click)="savePolygonAsFavorite()" class="success-button">
          <i class="fa fa-save"></i> Save
        </button>
        <button (click)="showPolygonNameInput = false" class="secondary-button">
          <i class="fa fa-times"></i> Cancel
        </button>
      </div>
    </div>
  </div>